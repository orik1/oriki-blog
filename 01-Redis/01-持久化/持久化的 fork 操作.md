[TOC]

# 持久化的 fork 操作

## 介绍

当 Redis 做 RDB 或 AOF 重写时，会进行 fork 操作创建子进程，对于大多数操作系统来说 fork 是个重量级操作。

虽然 fork 创建的子进程不需要拷贝父进程的物理内存空间，但是会复制父进程的空间内存页表。

## fork 操作的问题和优化

### 耗时问题

对于高流量的 Redis 实例 OPS 可达 5 万以上，如果 fork 操作耗时在秒级别将拖慢 Redis 命令执行，对线上应用延迟影响非常明显。

> 例如对于 10GB 的 Redis 进程，需要复制大约 20MB 的内存页表，因此 fork 操作耗时跟进程总内存量息息相关。
>
> 如果使用虚拟化技术，特别是 Xen 虚拟机，fork 操作会更耗时。

#### 耗时问题

正常情况下 fork 耗时应该是 GB/20ms 左右。可以在 `info stats` 统计中查 `latest_fork_usec` 指标获取最近一次 fork 操作耗时（单位微秒）。

#### 耗时的优化

1. 优先使用物理机或者高效支持 fork 操作的虚拟化技术，避免使用 Xen。

2. 控制 Redis 实例最大可用内存。

    > fork 耗时跟内存量成正比，线上建议每个 Redis 实例内存控制在 10GB 以内。

3. 合理配置 Linux 内存分配策略，避免物理内存不足导致 fork 失败。

4. 降低 fork 操作的频率，适度放宽 AOF 自动触发时机，还有避免不必要的全量复制等。

