# 子进程的开销监控与优化

子进程负责 AOF 或者 RDB 文件的重写，运行受到 CPU、内存、硬盘三部分管理。

## CPU

### 分析

子进程把进程内的数据分批写入文件。这个过程属于 CPU 密集操作，CPU 对单核的占用率接近 90%。

### 优化

1. 不做绑定单核 CPU 操作。由于子进程非常消耗 CPU，会和父进程产生单核资源竞争。

2. 不要和其他 CPU 密集型服务部署在一起。

3. 如果部署多个 Redis 实例，尽量保证同一时刻只有一个子进程执行重写工作。

    > 可以参考 Redis 多实例部署对 AOF 的影响 中**轮询控制 AOF** 的部分

## 内存

### 分析

子进程通过 fork 操作产生，理论上需要占用和父进程一样大小的内存。通过 Linux 的写时复制技术（copy-on-write），父子进程会共享相同的物理内存页，当父进程处理写请求时会把要修改的页创建副本，而子进程在 fork 操作过程中共享整个父进程内存快照。

内存消耗监控：

1. RDB 重写时，Redis 日志输出容如下：

    `* Background saving started by pid 7692`
    `* DB saved on disk`
    `* RDB: 5 MB of memory used by copy-on-write`
    `* Background saving terminated with success`

    如果重写过程中存在内存修改操作，父进程负责创建所修改内存页的副本，从日志中可以看出这部分内存消耗了 5MB，可以等价认为 RDB 重写消耗了 5MB 的内存。

2. AOF 重写时，Redis 日志输出容如下：

    `* Background append only file rewriting started by pid 8937`
    `* AOF rewrite child asks to stop sending diffs.`
    `* Parent agreed to stop sending diffs. Finalizing AOF...`
    `* Concatenating 0.00 MB of AOF diff received from parent.`
    `* SYNC append only file rewrite performed`
    `* AOF rewrite: 53 MB of memory used by copy-on-write`
    `* Background AOF rewrite terminated with success`
    `* Residual parent diff successfully flushed to the rewritten AOF (1.49 MB)`
    `* Background AOF rewrite finished successfully`
    
    父进程维护页副本消耗同 RDB 重写过程类似，但是 AOF 重写需要 AOF 重写缓冲区，因此根据以上日志可以预估内存消耗为：53MB + 1.49MB，也就是 AOF 重写时子进程消耗的内存量。

### 优化

1. 在部署多个 Redis 实例的时候，尽量保证同一时刻只有一个子进程在进行重写操作。
2. 避免在大量写入时做子进程重写操作，这样将导致父进程维护大量页副本造成内存消耗。

> Linux kernel 在 2.6.38 内核增加了 Transparent Huge Pages（THP），支持 huge page（2MB）的页分配，默认开启。
>
> 当开启时可以降低 fork 创建子进程的速度，但执行 fork 之后，如果开启 THP，复制页单位从原来 4KB 变为 2MB，会大幅增加重写期间父进程内存消耗。
>
> 建议设置 `sudo echo never>/sys/kernel/mm/transparent_hugepage/enabled` 关闭 THP。

## 硬盘

### 分析

AOF 或者 RDB 文件写入硬盘持久化。会造成硬盘写入压力。

根据 Redis 重写 AOF/RDB 的数据量，结合系统工具如 sar、iostat、iotop 等，可分析出重写期间硬盘负载情况。

### 优化

1. 不要和其他高硬盘负载的服务部署在一起，如：存储服务、消息队列服务等。

2. AOF 重写时会消耗大量硬盘 IO，可以开启配置 `no-appendfsync-on-rewrite`，默认关闭，表示在 AOF 重写期间不做 fsync 操作。

    > 配置 `no-appendfsync-on-rewrite = yes` 时，在极端情况下可能丢失整个 AOF 重写期间的数据，根据实际情况设置。

3. 当开启 AOF 功能的 Redis 用于高流量写入场景时，如果使用普通机械磁盘，写入吞吐一般在 100MB/s 左右，出现超过这种情况的时候需要做分摊操作。

4. 对于单机配置多个 Redis 实例的情况，可以配置不同实例分盘存储 AOF 文件，分摊硬盘写入压力。

    > 可以参考 Redis 多实例部署对 AOF 的影响 中**轮询控制 AOF** 的部分

